<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>International Inc - Locations</title>
    
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600&amp;subset=latin-ext" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
    <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="bower_components/components-font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    
    <style>
        #mapid { height: 400px; }
    </style>

    <!-- Keycloak Adapter Start-->
    <script src="SSO_URL/auth/js/keycloak.js"></script>
    <!-- Keycloak Adapter End -->
    
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <header class="site-header">
        <div class="top">
            <div class="container">
                <div class="row">
                    <div class="col-sm-6">
                        <p>International Inc Financial Services Wins Award</p>
                    </div>
                    <div class="col-sm-6">
                        <ul class="list-inline pull-right">
                            <li><a href="#"><i class="fa fa-facebook"></i></a></li>
                            <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                            <li><a href="#"><i class="fa fa-linkedin"></i></a></li>
                            <li><a href="#"><i class="fa fa-envelope-o"></i></a></li>
                            <li><a href="tel:+902222222222"><i class="fa fa-phone"></i>  +1 555 123 45 99</a></li>
                        </ul>                        
                    </div>
                </div>
            </div>
        </div>
        <nav class="navbar navbar-default">
			<div class="container">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar-collapse">
					<span class="sr-only">Toggle Navigation</span>
					<i class="fa fa-bars"></i>
				</button>
				<a href="index.html" class="navbar-brand">
					<img src="img/logo.png" alt="Post">
				</a>
                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse" id="bs-navbar-collapse">
                    <ul class="nav navbar-nav main-navbar-nav">
                        <li><a href="index.html" title="">HOME</a></li>
                        <li class="active"><a href="locations.html" title="">LOCATIONS</a></li>
                        <li><a href="category.html" title="">CATEGORY</a></li>
                        <!-- <li><a href="#" title="">MENU ITEM</a></li>
                        <li class="dropdown">
                            <a href="#" title="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">DEVELOPERS <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="#" title="">DOCUMENTATION</a></li>
                                <li><a href="#" title="">API PRODUCTS</a></li>
                            </ul>
                        </li> -->
                    </ul>                           
                </div><!-- /.navbar-collapse -->                
				<!-- END MAIN NAVIGATION -->
			</div>
		</nav>        
    </header>
    <div class="bread_area">
        <div class="container">
            <div class="row">
                <div class="col-sm-12">
                    <ol class="breadcrumb">
                        <li><a href="#">Home</a></li>
                        <li class="active">International Inc Office Locations</li>
                    </ol>                    
                </div>
            </div>
        </div>
    </div>
    <main class="site-main page-main">
        <div class="container">
            <div class="row">
                <section class="page col-sm-9">
                    <h2 class="page-title">Office Locations</h2>
                  
                    <ul class="nav nav-tabs">
                      <li class="active"><a data-toggle="tab" href="#home">Location Map</a></li>
                      <li><a data-toggle="tab" href="#menu1">Add Office</a></li>
                    </ul>
                  
                    <div class="tab-content">
                      <div id="home" class="tab-pane fade in active">
                       <h4>Office locations worldwide</h4>
                       <div>
                           <p>
                              <div id="mapid" ></div>
                          </p>
                          <!-- Keycloak Login Start -->
                          <p><a id="loginUrl" href="#" class="btn btn-primary">Sign In to access the Location API Service</a></p>
                          <!-- Keycloak Login End -->
                       </div>
                      </div>
                      <div id="menu1" class="tab-pane fade">
                          <h4> Add a new office location using the form below</h4>
                          <p>&nbsp;</p>
                          <form>
                              <div class="form-group row">
                                  <label for="inputLocationName" class="col-sm-2 col-form-label">Location Name</label>
                                  <div class="col-sm-5">
                                      <input type="text" class="form-control" id="inputLocationName" value="Vancouver">
                                  </div>
                              </div>
                              <div class="form-group row">
                                  <label for="inputLatitude" class="col-sm-2 col-form-label">Latitude</label>
                                  <div class="col-sm-5">
                                      <input type="text" class="form-control" id="inputLatitude" value="49.282820">
                                  </div>
                              </div>
                              <div class="form-group row">
                                  <label for="inputLongitude" class="col-sm-2 col-form-label">Longitude</label>
                                  <div class="col-sm-5">
                                      <input type="text" class="form-control" id="inputLongitude" value="-123.120288">
                                  </div>
                              </div>
                              <div class="form-group row">
                                  <label for="inputOfficeType" class="col-sm-2 col-form-label">Office Type</label>
                                  <div class="col-sm-5">
                                      <select class="custom-select mb-2 mr-sm-2 mb-sm-0" id="inputOfficeType">
                                          <option selected>Choose...</option>
                                          <option value="Regional Branch">Regional Branch</option>
                                          <option value="Local Office">Local Office</option>
                                          <option value="Headquarter">Headquarter</option>
                                          <option value="Kiosk">Kiosk</option>
                                          <option value="Tower Office">Tower Office</option>
                                          <option value="ATM">ATM</option>
                                          <option value="Bank">Bank</option>
                  
                                      </select>
                                  </div>
                              </div>
                              <div class="form-group row">
                                  <div class="offset-sm-2 col-sm-10">
                                      <!-- <hr> -->
                                      <button type="button" class="btn btn-primary" onclick="addNewLocation()">Add Office</button>
                                  </div>
                              </div>
                          </form>
                      </div>
                  
                    </div>
                </section>
                <aside class="sidebar col-sm-3">
                    <div class="widget">
                        <h4>OFFICE TYPE</h4>
                        <ul>
                            <li class="current"><a href="#" title="">Headquarters</a></li>
                            <li><a href="#" title="">Regional Office</a></li>
                            <li><a href="#" title="">Local Office</a></li>
                            <!-- <li><a href="admin.html">New Office</a></li> -->
                            <li><a href="#" data-toggle="collapse" data-target="#adminform">ATMs</a></li>

                        </ul>
                    </div>
                </aside>
            </div>
        </div>
    </main>
    <footer class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-3 col-sm-6 col-xs-12 fbox">
                    <h4>INTERNATIONAL INC</h4>
                    <p class="text">Internationl Inc (I-INC) is a corporatocratic mega-corporation that creates products for virtually every consumer need. </p>
                    <ul class="list-inline">
                        <li><a href="#"><i class="fa fa-facebook"></i></a></li>
                        <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                        <li><a href="#"><i class="fa fa-linkedin"></i></a></li>                        
                    </ul>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-12 fbox">
                    <h4>DIVISIONS</h4>
                    <ul class="big">
                        <li><a href="#" title="">Aerospace</a></li>
                        <li><a href="#" title="">Agriculture</a></li>
                        <li><a href="#" title="">Construction</a></li>
                        <li><a href="#" title="">Consumer Goods</a></li>
                        <li><a href="#" title="">Earth Transport</a></li>
                        <li><a href="#" title="">Electronics</a></li>
                        <li><a href="#" title="">Energy</a></li>
                        <li><a href="#" title="">Finance</a></li>
                    </ul>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-12 fbox">
                    <h4>&nbsp;</h4>
                    <ul class="big">
                        <li><a href="#" title="">Food Services</a></li>
                        <li><a href="#" title="">Fusion Research</a></li>
                        <li><a href="#" title="">Government</a></li>
                        <li><a href="#" title="">Hydro-power</a></li>
                        <li><a href="#" title="">Infrastructure</a></li>
                        <li><a href="#" title="">Media</a></li>
                        <li><a href="#" title="">Real State</a></li>
                        <li><a href="#" title="">Super Centers</a></li>
                    </ul>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-12 fbox">
                    <h4>AMERICAS</h4>
                    <p class="text">International Inc Towers, 1 International Plaza, Int Ave. 08012, USA.</p>
                    <p><a href="tel:+15551234599"><span class="glyphicon glyphicon-earphone" aria-hidden="true"></span> +1 555 123 45 99</a></p>
                    <p><a href="mailto:iletisim@agrisosgb.com"><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> mail@international.inc</a></p>
                </div>
            </div>
        </div>
        <div id="copyright">
            <div class="container">
                <div class="row">
                    <div class="col-md-4">
                        <p class="pull-left">&copy; 2018 INTERNATIONAL INC BY RED HAT</p>
                    </div>
                    <div class="col-md-8">
                        <ul class="list-inline navbar-right">
                            <!-- <li><a href="#">HOME</a></li>
                            <li><a href="#">MENU ITEM</a></li>
                            <li><a href="#">MENU ITEM</a></li>
                            <li><a href="#">MENU ITEM</a></li>
                            <li><a href="#">MENU ITEM</a></li>
                            <li><a href="#">MENU ITEM</a></li> -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>        
    </footer>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>

    <script>
        $(function () {
            // set the view to center on US
            var mymap = L.map('mapid').setView([15, 10], 1.5);
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.streets',
                accessToken: 'pk.eyJ1IjoiaGd1ZXJyZXJvbyIsImEiOiJjamdjbWx2Nm0xazl2MndvNDhiYmZ5MDI0In0.AdSTbfPP_0C0u5rkjDD7AA'
            }).addTo(mymap);

            // Keycloak Config Start

            var keyOptions = {
                url: 'SSO_URL/auth',
                realm: 'SSO_REALM',
                clientId: 'CLIENT_ID'
            };

            var keycloak = Keycloak(keyOptions);
            keycloak.init({ onLoad: 'check-sso' }).success(function (authenticated) {
                if (authenticated) {
                    $("<h4>Welcome " + keycloak.idTokenParsed.preferred_username + "</h4> ").insertBefore($('#mapid'));
                    callService(mymap, keycloak.token);
                    $('#mapid').show();
                    $('#loginUrl').hide();
                }
                else {
                    $('#mapid').hide();
                    $('#loginUrl').show();
                }
            }).error(function (data) {
                alert('Failed to initialize keycloak: ' + data);
            });

            var opts = {
                redirectUri: window.location.origin + "/locations.html"
            };

            var loginUrl = keycloak.createLoginUrl(opts);
            document.getElementById('loginUrl').href = loginUrl;

            // Keycloak Config End            
        });
        
        // REST CALL TO GET OFFICE DETAILS BASED ON THE OFFICE ID
        function getOfficeDetails (mapMarker, item){
            var office_id = item.id;
            $.ajax ({
                url: 'http://localhost:8001/locations/phone/' + office_id,
                dataType: 'json'
            }).done ( function (data){
                mapMarker.bindPopup('<b>' + item.name + '</b><br>' + item.type + '<br>' + data.phone);
            }).fail ( function (jqXHR, textStatus, errorThrown){
                console.log( 'Error:' + JSON.stringify(textStatus));
            })

        }

        // GET THE LIST OF OFFICES FROM THE FUSE (ONLINE) SERVICE
        function callService(map ,token){
            $.ajax({
                url: 'API_BACKEND_URL',
                // Keycloak Ajax Start
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                // Keycloak Ajax End
                dataType: 'json'
            }).done(function(data) {
                data.slice(0, data.length).map(function(item) {
                    var marker = L.marker([item.location.lat, item.location.lng]).addTo(map);
                    //marker.bindPopup('<b>' + item.name + '</b><br>' + item.type);
                    // CALL OUT TO OFFICE DETAIL SERVICE
                    getOfficeDetails(marker,item);
                    // marker.on('click', function (event){ 

                        
                    //     // marker.bindPopup('<b>' + item.name + '</b><br>' + item.type);
                    // });
                });
            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.log( 'Error:' + JSON.stringify(textStatus));
            });
        }

        // THIS FUNCTION WILL CALL THE NEWLY CREATED FUSE ONLINE FUNCTION
        // TO CREATE A NEW OFFICE LOCATION
        function addNewLocation (){

            var loc = $('#inputLocationName').val();
            var lat = $('#inputLatitude').val();
            var lon = $('#inputLongitude').val();
            var typ = $('#inputOfficeType').val();

            var payload = {
                "name" : loc,
                "type" : typ,
                "status" : "1",
                "location" : {
                "lat" : lat,
                "lng" : lon
                }
            }
            
            $.post ({
                url : 'FUSE_ONLINE_URL',
                data : payload
            }).done (function (data){
                console.log (JSON.stringify(data, null, 2));
                window.location = '/locations.html';
            }).fail (function (jqXHR, textStatus, errorThrown){
                console.log(textStatus);
            });
        }

    </script>
</body>
</html>